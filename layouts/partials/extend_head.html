{{- /* Head custom content area start */ -}}
{{- /*     Insert any custom code (web-analytics, resources, etc.) - it will appear in the <head></head> section of every page. */ -}}
{{- /*     Can be overwritten by partial with the same name in the global layouts. */ -}}

<!-- 增强内容安全策略 - 必须放在最前面 -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' 'unsafe-inline'
    https://busuanzi.ibruce.info
    http://busuanzi.ibruce.info
    https://www.googletagmanager.com
    https://cdn.jsdelivr.net
    https://giscus.app
    https://unpkg.com;
  style-src 'self' 'unsafe-inline'
    https://fonts.googleapis.com
    https://cdn.jsdelivr.net
    https://giscus.app;
  img-src 'self' data: https: blob:;
  font-src 'self'
    https://fonts.gstatic.com
    https://cdn.jsdelivr.net;
  connect-src 'self'
    https://busuanzi.ibruce.info
    http://busuanzi.ibruce.info
    https://www.google-analytics.com
    https://blog-analytics.finderyyh.workers.dev;
  frame-src
    https://giscus.app;
  object-src 'none';
  base-uri 'self';
  form-action 'self';
  frame-ancestors 'none';
  upgrade-insecure-requests;
">

<!-- 字体优化：暂时移除不完整的字体文件引用，使用系统字体 -->
<!-- 字体预加载已禁用，等待完整的字体子集化 -->
<!--
<link rel="preload" href="{{ "fonts/noto-serif-sc-v22-chinese-simplified-regular.woff2" | absURL }}" as="font" type="font/woff2" crossorigin>
-->

<!-- 图标优化 -->
<style>
/* 确保 SVG 图标正确显示 */
svg.icon {
    display: inline-block;
    width: 1em;
    height: 1em;
    vertical-align: -0.125em;
    fill: currentColor;
}

/* 站点logo尺寸 */
.logo svg, .logo img {
    max-height: 30px !important;
    width: auto !important;
}
</style>

<!-- 字体加载已禁用 - 等待完整的字体子集化 -->
<!--
<script>
// 检查字体是否已加载过
if (sessionStorage.getItem('fontsLoaded')) {
  document.documentElement.classList.add('fonts-loaded');
} else {
  // 如果浏览器支持FontFaceObserver，使用它来检测字体加载完成
  if ('FontFace' in window) {
    // 页面加载完毕后再加载非关键字体
    window.addEventListener('load', function() {
      setTimeout(function() {
        const fontLink = document.createElement('link');
        fontLink.href = '{{ "css/fonts.css" | absURL }}';
        fontLink.rel = 'stylesheet';
        document.head.appendChild(fontLink);

        // 标记字体已加载
        document.documentElement.classList.add('fonts-stage-1');
        // 全部字体加载后标记
        document.fonts.ready.then(function() {
          document.documentElement.classList.add('fonts-loaded');
          sessionStorage.setItem('fontsLoaded', 'true');
        });
      }, 500);  // 延迟加载字体，优先渲染页面内容
    });
  }
}
</script>
-->

<!-- 设置资源提示，加速资源发现和加载 -->
<link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="dns-prefetch" href="https://busuanzi.ibruce.info">
<link rel="preconnect" href="https://busuanzi.ibruce.info" crossorigin>
<link rel="dns-prefetch" href="https://giscus.app">
<link rel="preconnect" href="https://giscus.app" crossorigin>
<link rel="dns-prefetch" href="https://unpkg.com">

<!-- 页面渲染优化 -->
<meta name="renderer" content="webkit">
<meta name="force-rendering" content="webkit">
<!-- X-UA-Compatible 已在 head.html 中定义 -->

<!-- 响应式设计改进 -->
<!-- viewport 已在 head.html 中定义 -->
<meta name="format-detection" content="telephone=no">

<!-- PWA支持 -->
<meta name="theme-color" content="#ffffff">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- 优化关键CSS -->
<style>
/* 最重要的基础样式内联，避免CSS阻塞渲染 */
:root {
  --gap: 24px;
  --content-gap: 20px;
  --nav-width: 1024px;
  --main-width: 720px;
  --header-height: 60px;
  --footer-height: 60px;
  --radius: 8px;
}

@media screen and (max-width: 500px) {
  :root {
    --gap: 16px;
  }
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  background: var(--theme);
  transition: background 0.1s;
  margin: 0;
  padding: 0;
}

.fonts-loaded body {
  font-family: 'Noto Serif SC', 'Noto Serif', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
}

/* 提高图片加载体验 */
img {
  max-width: 100%;
  height: auto;
}
</style>

<!-- SVG 图标库 -->
{{- partial "svg-icons.html" . }}

{{- /* Head custom content area end */ -}}

{{ if (.Params.mermaid) }}
<script defer src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>
{{ end }}
<meta name="referrer" content="no-referrer-when-downgrade">

<!-- 不蒜子视图计数器 -->
<script defer src="{{ "js/busuanzi-view-counter.js" | absURL }}"></script>

<!-- 百度分析 -->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; //填自己的
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>